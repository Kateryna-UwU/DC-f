<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DC</title>
<style>
  :root{
    --bg:#0a0a0b; --card:#121216; --ink:#eef0f6; --muted:#a5abb6;
    --pill:#1a2030; --pill-b:#3f5bd9; --accent:#8aa2ff;
    --chip:#1c2030; --chip-b:#2a3350;
    --radius:16px; --gap:14px; --shadow:0 10px 28px rgba(0,0,0,.35);
    --maxw:900px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:16px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  a{color:var(--accent);text-decoration:none}
  .wrap{max-width:var(--maxw);margin:0 auto;padding:14px}
  header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(10,10,11,.98),rgba(10,10,11,.75) 55%,rgba(10,10,11,0))}
  .top{display:flex;align-items:center;gap:10px}
  .back{display:none;font-size:22px;cursor:pointer;padding:8px}
  .tabs{display:flex;gap:10px;flex:0 0 auto}
  .tab{padding:10px 16px;border-radius:999px;background:var(--pill);border:1.5px solid transparent;color:#cfd6ee;cursor:pointer}
  .tab.active{border-color:var(--accent);color:white}
  .spacer{flex:1}
  .search{display:flex;align-items:center;gap:8px}
  .search input{width:162px;max-width:42vw;padding:9px 12px;border-radius:999px;border:1px solid #262a35;background:#0f1016;color:var(--ink)}
  .menu{position:relative}
  .kebab{border:0;background:#1a1c24;color:#c8cfe4;border-radius:10px;padding:8px 10px;cursor:pointer}
  .menubox{position:absolute;right:0;top:44px;background:#0f1016;border:1px solid #2a2e3a;border-radius:12px;padding:8px;display:none;min-width:160px}
  .menubox button, .menubox a{width:100%;text-align:left;border:0;background:transparent;color:#e9edff;padding:8px 10px;border-radius:8px;display:block;cursor:pointer}

  .filters{display:none;gap:8px;flex-wrap:wrap;margin:10px 0}
  .filters.show{display:flex}
  .chip{padding:8px 12px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);color:#cfd6ee;cursor:pointer}
  .chip.active{background:#2b3655}

  main.wrap{padding-top:6px}
  .series-list{display:grid;gap:12px}
  .pill{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-radius:999px;background:#0f1119;border:2px solid var(--pill-b);box-shadow:var(--shadow);cursor:pointer}
  .pill .name{font-size:20px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .pill .count{opacity:.9}

  .grid{display:grid;gap:12px}
  .card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:12px;border:1px solid #272a36;cursor:pointer}
  /* ⇩ компактное превью */
  .card .media{
    width:100%; height:170px; border-radius:10px; overflow:hidden;
    background:#0f0f12; border:1px solid #24252b;
  }
  @media (max-width:480px){ .card .media{ height:150px } }
  .card .media img{ width:100%; height:100%; object-fit:cover; object-position:center; display:block }
  .meta{margin-top:10px}
  .line1{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .num{font-weight:800}
  .title{font-weight:650;opacity:.92}
  .sub{color:var(--muted)}
  .summary{margin-top:8px;color:#e9ebf6}
  .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .tag{padding:6px 10px;border-radius:999px;background:#1c2232;border:1px solid #2b3248;color:#e7ecff;cursor:pointer}

  .btn{padding:11px 14px;border-radius:10px;border:1px solid #2a2d36;background:#171820;color:#e9edff;cursor:pointer}
  .btn.primary{border-color:#3556ff;background:linear-gradient(180deg,#3b5bff,#2f48c9)}

  .fab{position:fixed;right:16px;bottom:16px;width:62px;height:62px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:white;color:black;font-size:34px;box-shadow:0 14px 34px rgba(0,0,0,.45);cursor:pointer;z-index:60;display:none}
  body.canEdit .fab{display:flex}
  body.editing .fab{display:none}

  .sheet{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:flex-end;z-index:70}
  .sheet.show{display:flex}
  .panel{background:#0f1118;border-top-left-radius:18px;border-top-right-radius:18px;box-shadow:0 -20px 40px rgba(0,0,0,.4);max-height:92vh;overflow:auto;width:100%}
  .panel .h{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #242838}
  .panel .body{padding:14px 16px}
  .row{display:grid;gap:10px;margin:10px 0}
  .row.cols{grid-template-columns:1fr 1fr}
  label{font-size:.9rem;color:#b9bfd3}
  input[type=text], input[type=number], textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #222839;background:#0f1016;color:var(--ink)}
  textarea{min-height:110px;resize:vertical}

  .grid-imgs{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px}
  .imgcell{position:relative;border:1px solid #272a33;border-radius:10px;overflow:hidden;background:#0f0f12}
  .imgcell img{width:100%;height:140px;object-fit:cover;display:block}
  .imgcell button{position:absolute;top:6px;right:6px;border:0;border-radius:8px;padding:6px 8px;background:rgba(0,0,0,.6);color:#fff;cursor:pointer}

  .viewer{position:fixed;inset:0;background:rgba(0,0,0,.93);display:none;align-items:center;justify-content:center;z-index:90}
  .viewer.show{display:flex}
  .viewer img{max-width:96vw;max-height:92vh;border-radius:12px}

  /* Страница главы */
  #chapter-page .chapter{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;border:1px solid #272a36}
  #chapter-page .hero{width:100%;border-radius:14px;overflow:hidden;background:#0f0f12;border:1px solid #24252b;margin-bottom:14px}
  #chapter-page .hero img{width:100%;height:auto;display:block}
  #chapter-page .h1{font-size:1.2rem;font-weight:800;margin:6px 0 2px}
  #chapter-page .muted{color:var(--muted)}
  #chapter-page .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  #chapter-page .tag{font-size:.9rem;padding:6px 10px;border-radius:999px;background:#1c1d23;color:#c7cbe0;border:1px solid #2a2d39}
  .navrow{display:flex;gap:10px;justify-content:space-between;margin-top:16px}
  .navrow .btn{flex:1}
</style>
</head>
<body>
  <header class="wrap">
    <div class="top">
      <div id="back" class="back" title="Back">←</div>
      <div class="tabs">
        <button class="tab active" id="tab-series">Series</button>
        <button class="tab" id="tab-tags">Tags</button>
      </div>
      <div class="spacer"></div>
      <div class="search"><input id="q" placeholder="Search…"></div>
      <div class="menu">
        <button class="kebab" id="menuBtn">⋯</button>
        <div class="menubox" id="menuBox">
          <div id="authArea">
            <div style="padding:6px 10px;color:#9aa3bb">Auth</div>
            <button id="btn-signin">Sign in</button>
            <button id="btn-signup">Sign up</button>
            <button id="btn-reset">Reset password</button>
            <button id="btn-logout" style="display:none">Log out</button>
          </div>
        </div>
      </div>
    </div>
    <div id="filters" class="filters"></div>
  </header>

  <main class="wrap">
    <div id="seriesView" class="series-list"></div>
    <div id="listView" class="grid" style="display:none"></div>
  </main>

  <!-- Полная страница главы -->
  <div id="chapter-page" class="wrap" style="display:none"></div>

  <button class="fab" id="fab" title="Add">+</button>

  <!-- Bottom sheet (form) -->
  <div class="sheet" id="sheet">
    <div class="panel">
      <div class="h">
        <div id="formTitle" style="font-weight:700">New Chapter</div>
        <button class="btn" id="closeSheet">Close</button>
      </div>
      <div class="body">
        <div class="row cols">
          <div><label>Series *</label><input id="f-series" type="text" placeholder="e.g. Batman v3 (2016)"></div>
          <div><label>Issue *</label><input id="f-issue" type="number" min="0" placeholder="e.g. 1"></div>
        </div>
        <div class="row cols">
          <div><label>Title</label><input id="f-title" type="text" placeholder="Issue title (optional)"></div>
          <div><label>Year</label><input id="f-year" type="number" placeholder="e.g. 2016"></div>
        </div>
        <div class="row cols">
          <div><label>Artist</label><input id="f-artist" type="text" placeholder="Artist"></div>
          <div><label>Writer</label><input id="f-writer" type="text" placeholder="Writer"></div>
        </div>
        <div class="row"><label>Summary</label><textarea id="f-summary" placeholder="Short summary…"></textarea></div>
        <div class="row">
          <label>Tags (comma-separated)</label>
          <input id="f-tags" type="text" placeholder="Tim, Family">
          <div style="margin-top:8px;color:#9aa3bb">Suggestions:</div>
          <div id="tag-suggestions" class="tags" style="margin-top:6px"></div>
        </div>
        <div class="row cols">
          <div><label>Link A (optional)</label><input id="f-linka" type="text" placeholder="https://…"></div>
          <div><label>Link B (optional)</label><input id="f-linkb" type="text" placeholder="https://…"></div>
        </div>
        <div class="row">
          <label>Images</label>
          <div class="tags" style="margin-bottom:8px">
            <button class="btn" id="btn-add-url" type="button">Add URL</button>
            <button class="btn" id="btn-upload" type="button">Upload file</button>
          </div>
          <div class="grid-imgs" id="img-grid"></div>
        </div>
        <div class="row" style="display:flex;gap:10px">
          <button class="btn" id="cancel">Cancel</button>
          <button class="btn primary" id="save">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- fullscreen image viewer -->
  <div id="viewer" class="viewer" title="Tap to close"><img alt=""></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
/* ====== CONFIG: заполни свои значения ====== */
const CONFIG = {
  SUPABASE_URL: "https://lzdbzspbahovmxutdxzt.supabase.co",
  SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6ZGJ6c3BiYWhvdm14dXRkeHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2OTYwODQsImV4cCI6MjA3MzI3MjA4NH0.a4yyqKVh-gb-A_74OoVRE1CBxRIwqbG6U508w4u0ZV0",
  OWNER_EMAIL: "katrineord@gmail.com",
  CLOUDINARY_CLOUD_NAME: "dm3zv8da4",
  CLOUDINARY_UNSIGNED_PRESET: "DC-comics",
  CLOUDINARY_FOLDER: "dc"
};
/* ========================================== */

const SUGGESTED_TAGS = [
  "Tim","Steph","Cluemaster","JackDrake","Bart","Conner","Cassy","YJ","Roy","Family","Batman","Robin","Batwoman", "Dick","Jason"
];

let supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
let session=null, canEdit=false;
let allNotes = []; // кэш
let currentSeries = null; // строка
let currentMode = 'series'; // 'series' | 'list-series' | 'list-tag'
let currentTag = null;

// для страницы главы/навигации
let seriesIndexCache = { key:null, list:[], pos:0 };

// редактирование
let editTarget = null;

// UI refs
const backBtn = document.getElementById('back');
const seriesView = document.getElementById('seriesView');
const listView = document.getElementById('listView');
const chapterPage = document.getElementById('chapter-page');
const tabSeries = document.getElementById('tab-series');
const tabTags = document.getElementById('tab-tags');
const filters = document.getElementById('filters');
const fab = document.getElementById('fab');
const viewerEl = document.getElementById('viewer');

/* ---------- init ---------- */
init().catch(console.error);

async function init(){
  // auth state
  const { data: { session: s } } = await supabase.auth.getSession();
  session = s;
  supabase.auth.onAuthStateChange((_evt, newSession)=>{
    session = newSession;
    refreshAuthUI();
    syncAuthMenu();
  });
  refreshAuthUI();
  syncAuthMenu();

  // UI events
  tabSeries.onclick = ()=> showSeries();
  tabTags.onclick = ()=> showTags();
  document.getElementById('q').oninput = handleSearch;
  backBtn.onclick = goBack;
  document.getElementById('menuBtn').addEventListener('click', (e)=>{ e.stopPropagation(); toggleMenu(); });
  document.addEventListener('click', ()=> document.getElementById('menuBox').style.display='none' );
  document.getElementById('viewer').onclick = ()=> viewer(false);

  // Auth menu
  document.getElementById('btn-signin').onclick = async()=>{
    const email = prompt('Email:'); if(!email) return;
    const pass = prompt('Password:'); if(!pass) return;
    const { error } = await supabase.auth.signInWithPassword({email, password:pass});
    if(error) return alert(error.message);
  };
  document.getElementById('btn-signup').onclick = async()=>{
    const email = prompt('Email:'); if(!email) return;
    const pass = prompt('Password: (min 6)'); if(!pass) return;
    const { error } = await supabase.auth.signUp({email, password:pass});
    if(error) return alert(error.message);
    alert('Check your email (confirm). Then sign in.');
  };
  document.getElementById('btn-reset').onclick = async()=>{
    const email = prompt('Email to reset:'); if(!email) return;
    const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: location.href });
    if(error) alert(error.message); else alert('Reset email sent.');
  };
  document.getElementById('btn-logout').onclick = async()=>{ await supabase.auth.signOut(); };

  // FAB & form sheet
  fab.onclick = ()=> openForm();
  wireForm();

  // tag suggestions
  const sugBox = document.getElementById('tag-suggestions');
  SUGGESTED_TAGS.forEach(t=>{
    const el = chip('#'+t); el.onclick=()=> addTagToInput(t);
    sugBox.appendChild(el);
  });

  // first load
  await loadAll();
  showSeries(); // стартовый экран
}

function refreshAuthUI(){
  canEdit = !!(session?.user?.email === CONFIG.OWNER_EMAIL);
  document.body.classList.toggle('canEdit', canEdit);
  document.getElementById('btn-logout').style.display = session?.user ? '' : 'none';
}
function syncAuthMenu(){
  const box = document.getElementById('menuBox');
  if(!box) return;
  // просто подменяем видимость Sign in/Log out
  document.getElementById('btn-signin').style.display = session?.user ? 'none' : '';
  document.getElementById('btn-signup').style.display = session?.user ? 'none' : '';
  document.getElementById('btn-reset').style.display = session?.user ? 'none' : '';
  document.getElementById('btn-logout').style.display = session?.user ? '' : 'none';
}

async function loadAll(){
  const { data, error } = await supabase.from('notes').select('*');
  if(error){ alert(error.message); return; }
  allNotes = (data||[]);
}

/* ---------- Views ---------- */
function showSeries(){
  currentMode='series'; currentSeries=null; currentTag=null;
  tabSeries.classList.add('active'); tabTags.classList.remove('active');
  backBtn.style.display='none';
  filters.classList.remove('show');
  chapterPage.style.display='none';
  listView.style.display='none';
  seriesView.style.display='';
  renderSeriesPills();
}
function showListForSeries(series){
  currentMode='list-series'; currentSeries=series; currentTag=null;
  tabSeries.classList.add('active'); tabTags.classList.remove('active');
  backBtn.style.display='block';
  filters.classList.remove('show');
  chapterPage.style.display='none';
  seriesView.style.display='none';
  listView.style.display='';
  const items = allNotes.filter(n=> n.series===series).sort((a,b)=>(a.issue??0)-(b.issue??0));
  renderCards(items);
}
function showTags(){
  currentMode='tags'; currentSeries=null; currentTag=null;
  tabSeries.classList.remove('active'); tabTags.classList.add('active');
  backBtn.style.display='none';
  chapterPage.style.display='none';
  seriesView.style.display='none';
  listView.style.display='none';
  renderTagFilters();
}
function showListForTag(tag){
  currentMode='list-tag'; currentTag=tag;
  backBtn.style.display='block';
  chapterPage.style.display='none';
  seriesView.style.display='none';
  listView.style.display='';
  const items = allNotes.filter(n=> (n.tags||[]).includes(tag)).sort((a,b)=>{
    if(a.series===b.series) return (a.issue??0)-(b.issue??0);
    return a.series.localeCompare(b.series);
  });
  renderCards(items);
}
function goBack(){
  if(currentMode==='list-series' || currentMode==='list-tag'){
    showSeries();
  }else if(chapterPage.style.display!=='none'){
    // вернуться к списку серии
    chapterPage.style.display='none';
    if(currentSeries){ showListForSeries(currentSeries); }
    else { showSeries(); }
  }
}

/* ---------- Renderers ---------- */
function renderSeriesPills(){
  seriesView.innerHTML='';
  const map = new Map();
  allNotes.forEach(n=>{
    const k = n.series||'—';
    map.set(k,(map.get(k)||0)+1);
  });
  [...map.entries()]
    .sort((a,b)=> a[0].localeCompare(b[0]))
    .forEach(([name,count])=>{
      const el = document.createElement('div'); el.className='pill';
      const left = document.createElement('div'); left.className='name'; left.textContent=name;
      const right = document.createElement('div'); right.className='count'; right.textContent=count;
      el.appendChild(left); el.appendChild(right);
      el.onclick = ()=> showListForSeries(name);
      seriesView.appendChild(el);
    });
  if(!map.size){
    const h = document.createElement('div');
    h.style.cssText='color:#9aa3bb;text-align:center;padding:26px';
    h.textContent='No data yet. Tap + to add your first chapter.';
    seriesView.appendChild(h);
  }
}

function renderCards(items){
  listView.innerHTML='';
  items.forEach(n=>{
    const c = document.createElement('div'); c.className='card';
    // клик по карточке — страница главы
    c.addEventListener('click', ()=> openChapterPage(n));

    // компактное превью (если есть)
    const first = (n.images && n.images.length) ? n.images[0] : null;
    if(first){
      const media = document.createElement('div'); media.className='media';
      const im = document.createElement('img');
      im.src = first; im.alt='';
      im.addEventListener('click', (e)=>{ e.stopPropagation(); viewer(true, first); });
      media.appendChild(im);
      c.appendChild(media);
    }

    const meta = document.createElement('div'); meta.className='meta';
    const l1 = document.createElement('div'); l1.className='line1';
    const num = document.createElement('div'); num.className='num'; num.textContent = '#'+(n.issue ?? '?'); l1.appendChild(num);
    if(n.title){ const t = document.createElement('div'); t.className='title'; t.textContent = n.title; l1.appendChild(t); }
    meta.appendChild(l1);
    const sub = document.createElement('div'); sub.className='sub';
    const bits = [];
    bits.push('—');
    bits.push((n.series||'').trim());
    if(n.year) bits.push('('+n.year+')');
    if(n.link_a) bits.push(`<a href="${n.link_a}" target="_blank" rel="noopener">Link A</a>`);
    if(n.link_b) bits.push(`<a href="${n.link_b}" target="_blank" rel="noopener">Link B</a>`);
    sub.innerHTML = bits.join(' ').replace(/\s+/g,' ').trim();
    meta.appendChild(sub);
    if(n.summary){
      const s = document.createElement('div'); s.className='summary';
      s.textContent = n.summary;
      meta.appendChild(s);
    }
    if(n.tags?.length){
      const tg = document.createElement('div'); tg.className='tags';
      n.tags.forEach(t=>{
        const el = chip('#'+t); el.onclick = (e)=>{ e.stopPropagation(); showListForTag(t); };
        tg.appendChild(el);
      });
      meta.appendChild(tg);
    }
    c.appendChild(meta);
    listView.appendChild(c);
  });
  if(!items.length){
    const h = document.createElement('div');
    h.style.cssText='color:#9aa3bb;text-align:center;padding:26px';
    h.textContent='Nothing here yet.';
    listView.appendChild(h);
  }
}

// Страница главы
function openChapterPage(note){
  // собрать список глав этой же серии
  const seriesKey = (note.series||'').toLowerCase();
  const list = allNotes
    .filter(x=> (x.series||'').toLowerCase()===seriesKey)
    .sort((a,b)=> (a.issue??0)-(b.issue??0));
  const pos = Math.max(0, list.findIndex(x=> x.id===note.id));
  seriesIndexCache = { key:seriesKey, list, pos };
  renderChapterPage();
}
function renderChapterPage(){
  const { list, pos } = seriesIndexCache;
  const n = list[pos];
  if(!n) return;

  seriesView.style.display='none';
  listView.style.display='none';
  backBtn.style.display='block';
  chapterPage.style.display='';
  chapterPage.innerHTML='';

  const page = document.createElement('div'); page.className='chapter';

  if(n.images?.length){
    const hero = document.createElement('div'); hero.className='hero';
    const img = document.createElement('img');
    img.src = n.images[0]; img.alt=n.title||'';
    img.addEventListener('click', ()=> viewer(true, n.images[0]));
    hero.appendChild(img); page.appendChild(hero);
  }

  const h1 = document.createElement('div'); h1.className='h1';
  h1.textContent = `#${n.issue}${n.title ? '  '+n.title : ''}`;
  page.appendChild(h1);

  const sub = document.createElement('div'); sub.className='muted';
  const bits = [];
  if(n.series) bits.push(n.series);
  if(n.year) bits.push(String(n.year));
  let links = '';
  if(n.link_a) links += ` · <a href="${n.link_a}" target="_blank" rel="noopener">Link A</a>`;
  if(n.link_b) links += ` · <a href="${n.link_b}" target="_blank" rel="noopener">Link B</a>`;
  sub.innerHTML = (bits.length? '— '+bits.join(' · ') : '—') + links;
  page.appendChild(sub);

  if(n.artist || n.writer){
    const aw = document.createElement('div'); aw.className='muted'; aw.style.marginTop='6px';
    aw.textContent = [n.artist, n.writer].filter(Boolean).join(' / ');
    page.appendChild(aw);
  }

  if(n.summary){
    const p = document.createElement('div'); p.style.marginTop='12px';
    p.textContent = n.summary;
    page.appendChild(p);
  }

  if(n.tags?.length){
    const tg = document.createElement('div'); tg.className='tags';
    n.tags.forEach(t=>{
      const chipEl = document.createElement('span'); chipEl.className='tag'; chipEl.textContent='#'+t;
      chipEl.addEventListener('click', ()=>{ chapterPage.style.display='none'; showListForTag(t); });
      tg.appendChild(chipEl);
    });
    page.appendChild(tg);
  }

  const nav = document.createElement('div'); nav.className='navrow';
  const prev = document.createElement('button'); prev.className='btn'; prev.textContent='← Prev';
  prev.disabled = (pos<=0);
  prev.onclick = ()=>{ seriesIndexCache.pos = Math.max(0, seriesIndexCache.pos-1); renderChapterPage(); };

  const edit = document.createElement('button'); edit.className='btn primary'; edit.textContent='Edit';
  if (canEdit) edit.onclick = ()=> openForm(n); else edit.disabled=true;

  const next = document.createElement('button'); next.className='btn'; next.textContent='Next →';
  next.disabled = (pos>=list.length-1);
  next.onclick = ()=>{ seriesIndexCache.pos = Math.min(list.length-1, seriesIndexCache.pos+1); renderChapterPage(); };

  nav.append(prev, edit, next);
  page.appendChild(nav);

  const back = document.createElement('div'); back.style.marginTop='10px';
  const backBtn2 = document.createElement('button'); backBtn2.className='btn'; backBtn2.textContent='Back';
  backBtn2.onclick = goBack;
  back.appendChild(backBtn2);
  page.appendChild(back);

  chapterPage.appendChild(page);
}

/* ---------- Search ---------- */
function handleSearch(){
  const q = document.getElementById('q').value.trim().toLowerCase();
  if(!q){
    if(chapterPage.style.display!=='none'){ /* остаёмся на странице главы */ return; }
    if(currentMode==='series') renderSeriesPills();
    else if(currentMode==='list-series') showListForSeries(currentSeries);
    else if(currentMode==='list-tag') showListForTag(currentTag);
    return;
  }
  const filtered = allNotes.filter(n=>{
    const bag = [
      n.series, n.title,
      String(n.issue ?? ''),
      (n.tags||[]).join(' ')
    ].filter(Boolean).join(' ').toLowerCase();
    return bag.includes(q);
  });
  chapterPage.style.display='none';
  seriesView.style.display='none';
  listView.style.display='';
  backBtn.style.display='block';
  renderCards(filtered.sort((a,b)=>{
    if(a.series===b.series) return (a.issue??0)-(b.issue??0);
    return a.series.localeCompare(b.series);
  }));
}

/* ---------- Helpers ---------- */
function chip(text){
  const el = document.createElement('span'); el.className='chip'; el.textContent=text;
  return el;
}
function toggleMenu(){
  const box = document.getElementById('menuBox');
  box.style.display = box.style.display==='block' ? 'none' : 'block';
}
function viewer(show, url=''){
  if(show){ viewerEl.querySelector('img').src=url; viewerEl.classList.add('show'); history.pushState({viewer:1},''); }
  else { viewerEl.querySelector('img').src=''; viewerEl.classList.remove('show'); }
}
window.addEventListener('popstate', ()=>{ if(viewerEl.classList.contains('show')) viewer(false); });

/* ---------- Form (create / edit) ---------- */
function wireForm(){
  const sheet = document.getElementById('sheet');
  document.getElementById('closeSheet').onclick = closeForm;
  document.getElementById('cancel').onclick = closeForm;
  document.getElementById('btn-add-url').onclick = ()=>{
    const url = prompt('Paste image URL'); if(!url) return;
    imagesLocal.push(url.trim()); refreshImages();
  };
  document.getElementById('btn-upload').onclick = async ()=>{
    const fi = document.createElement('input'); fi.type='file'; fi.accept='image/*'; fi.multiple=true;
    fi.onchange = async ()=>{
      if(!fi.files?.length) return;
      for(const file of fi.files){
        const form = new FormData();
        form.append('file', file);
        form.append('upload_preset', CONFIG.CLOUDINARY_UNSIGNED_PRESET);
        if(CONFIG.CLOUDINARY_FOLDER) form.append('folder', CONFIG.CLOUDINARY_FOLDER);
        try{
          const res = await fetch(`https://api.cloudinary.com/v1_1/${CONFIG.CLOUDINARY_CLOUD_NAME}/upload`, { method:'POST', body:form });
          const json = await res.json();
          if(json.secure_url){ imagesLocal.push(json.secure_url); refreshImages(); }
          else { throw new Error(json.error?.message||'Upload failed'); }
        }catch(e){ alert(e.message); }
      }
    };
    fi.click();
  };
  document.getElementById('save').onclick = saveForm;

  // local images buffer
  window.imagesLocal = [];
  const grid = document.getElementById('img-grid');
  function refreshImages(){
    grid.innerHTML='';
    imagesLocal.forEach((u,idx)=>{
      const cell = document.createElement('div'); cell.className='imgcell';
      const im = document.createElement('img'); im.src=u; im.alt=''; im.onclick=()=> viewer(true,u);
      const rm = document.createElement('button'); rm.textContent='×'; rm.title='Remove';
      rm.onclick=()=>{ imagesLocal.splice(idx,1); refreshImages(); };
      cell.appendChild(im); cell.appendChild(rm); grid.appendChild(cell);
    });
  }
  window.refreshImages = refreshImages;

  function closeForm(){
    sheet.classList.remove('show');
    document.body.classList.remove('editing');
    editTarget = null;
  }
}

function openForm(existing){
  if(!canEdit){ alert('Sign in as owner to add/edit.'); return; }
  const f = (id)=>document.getElementById(id);
  if(existing){
    editTarget = existing;
    document.getElementById('formTitle').textContent = 'Edit Chapter';
    f('f-series').value = existing.series || '';
    f('f-issue').value = existing.issue ?? '';
    f('f-title').value = existing.title || '';
    f('f-year').value = existing.year ?? '';
    f('f-artist').value = existing.artist || '';
    f('f-writer').value = existing.writer || '';
    f('f-summary').value = existing.summary || '';
    f('f-tags').value = (existing.tags||[]).join(', ');
    f('f-linka').value = existing.link_a || '';
    f('f-linkb').value = existing.link_b || '';
    imagesLocal = (existing.images||[]).slice(); refreshImages();
  } else {
    editTarget = null;
    document.getElementById('formTitle').textContent = 'New Chapter';
    f('f-series').value = currentSeries || '';
    f('f-issue').value = '';
    f('f-title').value = '';
    f('f-year').value = '';
    f('f-artist').value = '';
    f('f-writer').value = '';
    f('f-summary').value = '';
    f('f-tags').value = '';
    f('f-linka').value = '';
    f('f-linkb').value = '';
    imagesLocal.length=0; refreshImages();
  }
  document.getElementById('sheet').classList.add('show');
  document.body.classList.add('editing');
}
function addTagToInput(tag){
  const input = document.getElementById('f-tags');
  const cur = input.value.split(',').map(s=>s.trim()).filter(Boolean);
  if(!cur.includes(tag)) cur.push(tag);
  input.value = cur.join(', ');
}

async function saveForm(){
  const fval = (id)=>document.getElementById(id).value.trim();
  const series = fval('f-series'); const issueStr = fval('f-issue');
  if(!series || !issueStr) return alert('Series and Issue are required.');
  const payload = {
    series,
    issue: parseInt(issueStr,10),
    title: fval('f-title') || null,
    year: fval('f-year') ? parseInt(fval('f-year'),10) : null,
    artist: fval('f-artist') || null,
    writer: fval('f-writer') || null,
    summary: fval('f-summary') || null,
    tags: fval('f-tags') ? fval('f-tags').split(',').map(s=>s.trim()).filter(Boolean) : [],
    link_a: fval('f-linka') || null,
    link_b: fval('f-linkb') || null,
    images: imagesLocal.slice(),
    user_id: session?.user?.id || null
  };

  let error;
  if(editTarget?.id){
    ({ error } = await supabase.from('notes').update(payload).eq('id', editTarget.id));
  }else{
    ({ error } = await supabase.from('notes').insert(payload));
  }
  if(error) return alert('Save error: '+error.message);

  // refresh
  await loadAll();
  document.getElementById('sheet').classList.remove('show');
  document.body.classList.remove('editing');
  editTarget = null;

  // если мы были на странице главы — обновим её, иначе вернёмся к серии
  if(chapterPage.style.display!=='none' && seriesIndexCache.list.length){
    // перестроим позиции
    const seriesKey = (payload.series||'').toLowerCase();
    const list = allNotes.filter(x=> (x.series||'').toLowerCase()===seriesKey)
                         .sort((a,b)=> (a.issue??0)-(b.issue??0));
    const pos = Math.max(0, list.findIndex(x=> editTarget ? x.id===editTarget.id : (x.series===payload.series && x.issue===payload.issue)));
    seriesIndexCache = { key:seriesKey, list, pos };
    renderChapterPage();
  } else {
    showListForSeries(payload.series);
  }
}

/* ---------- Misc ---------- */
function renderTagFilters(){
  filters.innerHTML=''; filters.classList.add('show');
  const all = new Set();
  allNotes.forEach(n=> (n.tags||[]).forEach(t=> all.add(t)));
  if(!all.size){
    const msg = document.createElement('div');
    msg.style.cssText='color:#9aa3bb;padding:20px';
    msg.textContent='No tags yet. Add chapters first.';
    filters.appendChild(msg);
    return;
  }
  [...all].sort((a,b)=> a.localeCompare(b)).forEach(t=>{
    const el = chip('#'+t); el.onclick=()=> showListForTag(t);
    filters.appendChild(el);
  });
}
</script>
</body>
</html>
